/**
 * =================================================================
 * 1. CONFIGURATION DES ICONES ET DU STYLE
 * =================================================================
 */
var CONFIG = {
    docStatus: {
        DOC:  { icon: "â– ", label: "Description textuelle prÃ©sente" },
        LINK: { icon: "âž¤", label: "Lien externe prÃ©sent (Doc ou PropriÃ©tÃ© URL)" }
    },
    specType: {
        SPECX:  { icon: "â–", label: "une SpÃ©cialisation est prÃ©sente" },
        APPLI:  { icon: "âš™", label: "Appli GLPI (App-Component)" },
        APP_SERVICE:  { icon: "ðŸ”Œ", label: "Service Applicatif" },
        BUSINESS_OBJ: { icon: "ðŸ‘¤", label: "Objet MÃ©tier" },
        DATA_OBJ:      { icon: "ðŸ’¾", label: "Objet de DonnÃ©es" },
        VALIDATED:    { icon: "âœ”", label: "Processus / Validation" }
    },
    colors: {
        LINK_PRESENT: "#0064ff", 
        DEFAULT: "#000000"       
    },
    font: {
        NAME: "Segoe UI Symbol"
    },
    debug: true
};

/**
 * =================================================================
 * 2. LOGIQUE DE FORMATAGE DU TEXTE
 * =================================================================
 */
function getLabelFormat(o, type, spec, hasPureText, hasLink) {
    // Cas spÃ©cifique pour les NOTES
    if (type === "diagram-model-note") {
        return o.labelExpression; // On retourne le texte actuel tel quel
    }

    var t = type ? type.toLowerCase() : "";
    var s = spec ? spec : "";
    var prefix = "";

    if (t === "application-component" && s === "Appli") prefix = CONFIG.specType.APPLI.icon + " "; 
    else if (t === "application-service") prefix = CONFIG.specType.APP_SERVICE.icon + " ";
    else if (t === "business-object") prefix = CONFIG.specType.BUSINESS_OBJ.icon + " ";
    else if (t === "data-object") prefix = CONFIG.specType.DATA_OBJ.icon + " ";
    else if (t === "business-process" && s === "Validation") prefix = CONFIG.specType.VALIDATED.icon + " ";
    else prefix = (s !== "" ? CONFIG.specType.SPECX.icon + " " : "");

    var suffix = "";
    if (hasPureText || hasLink) suffix += "  |";
    if (hasPureText) suffix += " " + CONFIG.docStatus.DOC.icon;
    if (hasLink)     suffix += " " + CONFIG.docStatus.LINK.icon;
    
    return prefix + "${name}" + suffix;
}

/**
 * =================================================================
 * 3. LOGIQUE D'APPLICATION DES STYLES
 * =================================================================
 */
function applyStyle(object, hasLink) {
    try {
        var currentStyle = object.fontStyle; 
        if (!currentStyle) currentStyle = "normal";

        var isBold = (currentStyle.indexOf("bold") !== -1);
        var isItalic = (currentStyle.indexOf("italic") !== -1);

        var newBaseStyle = "normal";
        if (isBold && isItalic) newBaseStyle = "bolditalic";
        else if (isBold) newBaseStyle = "bold";
        else if (isItalic) newBaseStyle = "italic";

        object.fontStyle = newBaseStyle;
        object.fontColor = hasLink ? CONFIG.colors.LINK_PRESENT : CONFIG.colors.DEFAULT;
        object.fontName = CONFIG.font.NAME;
    } catch(e) { }
}

/**
 * =================================================================
 * 4. EXECUTION
 * =================================================================
 */
var modifiedCount = 0; 
console.show();
console.clear();
console.log("> Start - Mise Ã  jour globale (Protection des Notes)");

function processObject(o) {
    // Si l'objet n'a pas de Label Expression (ex: une Vue), on traite les rÃ©fÃ©rences
    if (o.labelExpression === undefined) {
        var concept = o.concept ? o.concept : (o.type && o.type.indexOf("view") == -1 ? o : null);
        if (concept && concept.type) {
            $(concept).viewRefs().each(function(vRef) { processObject(vRef); });
        }
        return; 
    }

    var concept = o.concept ? o.concept : o; // Pour une Note, le concept c'est l'objet lui-mÃªme
    if (concept && concept.type) {
        try {
            var docText = concept.documentation ? concept.documentation.trim() : "";
            var propURL = concept.prop("URL") ? concept.prop("URL").trim() : "";
            var fullAnalysisText = docText + " " + propURL;

            var urlRegex = /https?:\/\/[^\s]+/gi;
            var hasLink = urlRegex.test(fullAnalysisText);
            var pureTextOnly = docText.replace(urlRegex, "").trim();
            var hasPureText = (pureTextOnly.length > 0);
            
            // On passe l'objet complet Ã  getLabelFormat pour gÃ©rer le texte des notes
            var expression = getLabelFormat(o, concept.type, concept.specialization, hasPureText, hasLink);
            
            applyStyle(o, hasLink);
            
            // On ne met Ã  jour que si l'expression change (et on ignore si expression est nulle/undefined)
            if (expression !== undefined && o.labelExpression !== expression) {
                o.labelExpression = expression;
                modifiedCount++;
            }
        } catch (e) {
            if(CONFIG.debug) console.log(" ! Erreur sur " + o.name + ": " + e.message);
        }
    }
}

$(selection).each(function(item) {
    if (item.type === "folder") {
        $(item).find().each(function(o) { processObject(o); });
    } else if (item.type && item.type.endsWith("-view")) {
        $(item).find().each(function(o) { processObject(o); });
    } else {
        processObject(item);
    }
});

console.log("\nâœ… " + modifiedCount + " modifications effectuÃ©es.");
console.log("\n--- LÃ‰GENDE ---");
for (var key in CONFIG.docStatus) console.log(CONFIG.docStatus[key].icon + " : " + CONFIG.docStatus[key].label);
for (var key in CONFIG.specType) console.log(CONFIG.specType[key].icon + " : " + CONFIG.specType[key].label);