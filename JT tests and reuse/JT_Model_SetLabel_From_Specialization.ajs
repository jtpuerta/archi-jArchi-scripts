debug = true;
console.show();
console.clear();
console.log("> Start - Mise √† jour des labels");

/**
 * D√©finit le label selon le type et la sp√©cialisation
 */
function getLabelFormat(type, spec) {
    // Nettoyage des entr√©es
    var t = type ? type.toLowerCase() : "";
    var s = spec ? spec : "";

    // --- TEST DES COMBINAISONS ---
    
    // Cas 1 : Processus m√©tier avec sp√©cialisation "Validation"
    if (t === "business-process" && s === "Validation") {
        return "‚úÖ ${name} (Valid√©)";
    }

    // Cas 2 : Composant applicatif critique
    if (t === "application-component" && s === "Critique") {
        return "‚ö†Ô∏è [APP] ${name}";
    }

    // Cas par d√©faut selon le type technique
    switch(t) {
        case "business-object":
            return "üë§ <<${specialization}>> \n ${name}";
        case "data-object":
            return "üíæ ${name}";
        case "application-service":
            return "‚öôÔ∏è Svc: ${name}";
        default:
            // Format standard si rien ne correspond
            return s !== "" ? "<<${specialization}>> \n ${name}" : "${name}";
    }
}

// --- Logique d'ex√©cution ---

// 1. On capture la s√©lection brute
var rawSelection = selection; 
debug ? console.log("Objets bruts d√©tect√©s : " + rawSelection.length) : true;

// 2. Tentative de r√©cup√©ration des objets de diagramme
// On essaie de convertir la s√©lection en collection Archi (plus robuste)
var visualObjects = $(selection).filter("diagram-model-reference");
debug ? console.log("Objets visuels d√©tect√©s : " + visualObjects.length) : true;

// 3. SI VIDE : On tente de chercher les repr√©sentations des concepts s√©lectionn√©s dans l'arbre
if (visualObjects.size() === 0) {
    visualObjects = $(selection).find("diagram-model-reference");
}

// JTP: je tente
visualObjects = rawSelection;

if (visualObjects.size() === 0) {
    console.log("!! Erreur : S√©lectionnez des formes dans une vue Archi.");
} else {
    visualObjects.each(function(o) {
        if (o.concept) {
            try {
                // On r√©cup√®re le format via notre fonction
                var expression = getLabelFormat(o.concept.type, o.concept.specialization);
                
                // On applique l'expression dynamique
                o.labelExpression = expression;
                
                debug ? console.log("Mis √† jour : " + o.name) : true;
            } catch (e) {
                console.log("Impossible d'appliquer le label sur " + o.name + " : " + e.message);
            }
        }
    });
    console.log("> Op√©ration termin√©e sur " + visualObjects.size() + " objet(s).");
}