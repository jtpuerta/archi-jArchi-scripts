/*
 * Create a Folder and 2 views for an Application : Analyse et Detail
 * + Create a Viewref toward the Detail View
 */

debug = true;

console.show();
console.clear();
console.log("> Start");

// variables
var theConceptVO;
var theConcept;
var theView;
var theFolder;
var theViewDetail;
var theViewUsage;

// la selection doit se faire sur un VO, dans une Vue
theConceptVO = $(selection).filter("application-component").first();

// theConceptVO doit être une Application / dans une vue 
if(!theConceptVO) {
    console.log("!! one Application must be selected in the current view")
    exit();
}
theView = theConceptVO.view;
if(!theView) {
    console.log("!! one Application must be selected in the current view")
    exit();
}
debug ? console.log("theConceptVO = " + theConceptVO.name) : true;
debug ? console.log("theView = " + theView.name) : true;

// theConcept correspondant à theConceptVO doit être bien classé: dans un folder/folder de "Application"
theConcept = theConceptVO.concept;
debug ? console.log("theConcept Parent x 3 = " + $(theConcept).parent().parent().parent()) : true;
if($(theConcept).parent().parent().parent().first().name != "Application"){
    console.log("!! theconcept doit être classé dans un sous-sous-repertoire de Application");
    exit();
}

// si le Folder avec le nom du Concept n'existe pas déja (dans les Views), alors Création
theFolder = $("folder.Views").find("folder").filter( folder => {
    return folder.name == theConceptVO.name ? true : false;
}).first();
debug ? console.log("theFolder = " + theFolder) : true;

if(theFolder){
    console.log("> The Folder already exists");
}else{
    console.log("> The Folder does not exist");

    // Création du Folder et de la view  ViewDetail 
    theFolder = $("folder.Views").first().createFolder(theConceptVO.name);
    theViewDetail = model.createArchimateView("Default",theFolder);
    theViewDetail.name = "Detail";
    debug ? console.log("theFolder and the view are created") : true;

    // Ajout du viewRef vers "TOC"
    var theTocView = $(".TOC").filter("archimate-diagram-model").first() ;
    var theTocViewRef1 = theViewDetail.createViewReference(theTocView, 10, 10, 70, 25);
     debug ? console.log("theTocViewRef are created") :  true;

    // Ajout du viewRef vers "Map des Applications"
    var theMapView = $(".Map des Applications").filter("archimate-diagram-model").first() ;
    if(!theMapView) {
        console.log("!! 'Map des Applications'  does not exist")
        exit();
    } else {
        debug ? console.log("theMapView = " + theMapView.name) : true;
    }
    var theMapViewRef1 = theViewDetail.createViewReference(theMapView, 90, 10, 210, 25);
     debug ? console.log("theMapViewRef is created") :  true;

    // Ajout de la note de Titre avec le "périmètre" pour préfixe - cf le controle que le concept soit "bien" classé
    var theConceptParent = $(theConcept).parent().first();
    var theConceptParent2 = $(theConceptParent).parent().first();
    var theNoteDetail = theViewDetail.createObject("diagram-model-note", 310, 10, 600, 25)
    theNoteDetail.setText(theConceptParent2.name );
    theNoteDetail.fontStyle = "bold";
    theNoteDetail.setLabelExpression("${content} / $vfolder{name} / $view{name}");

     debug ? console.log("theNote is created") :  true;
}

// Ajout d'un ViewRef sur theConceptVO (si il n'y en a pas déja un)
if($(theConceptVO).children("diagram-model-reference").size()==0){
    console.log("> theConceptVOViewRef has to be created ");

    if(!theViewDetail){
        // si theViewDetail n'est pas défini, c'est qu'il existe déja (TODO refactor ?)
        theViewDetail = $(theFolder).children().filter(c=>{return c.name == "Detail"}).first();
        debug ? console.log("theViewDetail qui existe déja = " + theViewDetail) : true;
        debug ? console.log("theViewDetail qui existe déja (parent) = " + $(theViewDetail).parent().first().name) : true;
    }

    // création of theConceptVOViewRef : systématiquement vers Détail
    var theConceptVOViewRef = theConceptVO.createViewReference(theViewDetail, 0, 0, 25, 25); 
}
else{
    console.log("> theConceptVOViewRef already exists");
    debug ? console.log("- " + $(theConceptVO).children("diagram-model-reference").first()) : true;

}
console.log("> End");